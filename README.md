# RAG æ™ºèƒ½ä½“

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå¯è·¯ç”±çš„ RAG Pipelineï¼šä»æ„å›¾è¯†åˆ«ã€æ£€ç´¢è·¯ç”±ã€ç½®ä¿¡åº¦èåˆåˆ°ç­”æ¡ˆç”Ÿæˆä¸æµå¼è¾“å‡ºï¼Œè¦†ç›–æœ¬åœ° PDF ä¸ Web æ£€ç´¢ä¸¤è·¯ï¼Œæ”¯æŒæ‰¹é‡é—®ç­”ä¸æŒä¹…åŒ–å‘é‡ç´¢å¼•ã€‚

## Pipeline æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚                    ğŸ§   RAG Agent Pipeline              â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                          â”‚ 
                          â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ â‘  User Question                             â”‚ 
â”‚   e.g. â€œ2025Q2 çš„å‡€æ¯å·®ä¸ºä½•ä¸‹é™ï¼Ÿâ€         â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                          â”‚ 
                          â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ â‘¡ Intent Classifier (æ„å›¾åˆ†ç±»å™¨)            â”‚ 
â”‚   â”œâ”€ data_lookup         â†’ æŸ¥å…·ä½“æ•°å€¼        â”‚ 
â”‚   â”œâ”€ definition_lookup    â†’ æŸ¥å®šä¹‰å£å¾„        â”‚ 
â”‚   â”œâ”€ reasoning            â†’ è§£é‡Š/ç»¼åˆåˆ†æ     â”‚ 
â”‚   â”œâ”€ external_context     â†’ å®è§‚/è¡Œä¸šå¤–éƒ¨ä¿¡æ¯ â”‚ 
â”‚   â”œâ”€ forecast             â†’ é¢„æµ‹/å±•æœ›é—®é¢˜     â”‚ 
â”‚   â””â”€ meta_query           â†’ å…³äºæ–‡æ¡£æœ¬èº«      â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                          â”‚ 
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
                  â–¼                              â–¼ 
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
        â”‚ â‘¢ Retrieval Router  â”‚         â”‚ (Rule + LLM åˆ¤æ–­)     â”‚ 
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                          â”‚ 
                          â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ â‘£ Route by Intent                             â”‚ 
â”‚   â”œâ”€ data_lookup / definition / meta â†’ Local   â”‚ 
â”‚   â”œâ”€ external_context / forecast     â†’ Web     â”‚ 
â”‚   â”œâ”€ reasoning                      â†’ Both     â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                          â”‚ 
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
                 â–¼                  â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ Local Retriever  â”‚  â”‚ Web Retriever    â”‚ 
â”‚ (e.g. PDF RAG)   â”‚  â”‚ (e.g. WebSearch) â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                 â”‚                  â”‚ 
                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                         â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ â‘¤ Confidence Fusion Layer (ç½®ä¿¡åº¦èåˆå±‚)      â”‚ 
â”‚   Inputs:                                      â”‚ 
â”‚     - similarity_score                         â”‚ 
â”‚     - source_reliability (local=0.9, web=0.6)  â”‚ 
â”‚     - recency_score                            â”‚ 
â”‚   score_i = 0.6*sim + 0.3*reliab + 0.1*recency â”‚ 
â”‚   â†’ å½’ä¸€åŒ– + MMR é€‰ Top-K å¹¶èåˆ               â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                         â”‚ 
                         â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ â‘¥ Answer Generator (LLM)                      â”‚ 
â”‚   - è¾“å…¥ï¼šé—®é¢˜ + èåˆåçš„ä¸Šä¸‹æ–‡                â”‚ 
â”‚   - è¾“å‡ºï¼šå¼•ç”¨æœ¬åœ°æŠ¥å‘Š + å¤–éƒ¨èƒŒæ™¯çš„å®Œæ•´ç­”æ¡ˆ     â”‚ 
â”‚   ä¾‹ï¼š                                         â”‚ 
â”‚   â€œæ ¹æ®æ‹›å•†é“¶è¡Œ2025å¹´åŠå¹´æŠ¥ï¼Œå‡€æ¯å·®ä¸‹é™5bp... â”‚ 
â”‚     åŒæœŸè¡Œä¸šæ•´ä½“äº¦å—LPRä¸‹é™å½±å“...â€            â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
                         â”‚ 
                         â–¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ â‘¦ Final Answer to User                        â”‚ 
â”‚   - ç»“åˆæœ¬åœ°è¯æ® + å¤–éƒ¨è¯­å¢ƒ                   â”‚ 
â”‚   - é™„å‡ºå¤„å¼•ç”¨ä¸ç½®ä¿¡åº¦æ ‡æ³¨                   â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
```

## æ¨¡å—æ˜ å°„ä¸å®ç°

- æ„å›¾åˆ†ç±»å™¨ï¼š`rag_agent/router/intent_classifier.py`ï¼ˆè°ƒç”¨ `rag_agent/llm/classifier_llm.py`ï¼‰
  - LLM ç”Ÿæˆä¸¥æ ¼ JSONï¼š`intent`ã€`confidence`ã€`need_web`ã€`need_local` ç­‰ã€‚
  - å…è®¸çš„æ„å›¾é›†ï¼šdata_lookupã€definition_lookupã€reasoningã€external_contextã€forecastã€meta_queryã€‚

- æ£€ç´¢è·¯ç”±ï¼š`rag_agent/router/retrieval_router.py`
  - è§„åˆ™ï¼š
    - data_lookup / definition_lookup / meta_query â†’ ä»…æœ¬åœ°ã€‚
    - external_context / forecast â†’ ä»… Webã€‚
    - reasoning â†’ æœ¬åœ° + Web åŒè·¯ã€‚

- æœ¬åœ°æ£€ç´¢ï¼š`rag_agent/retriever/local_retriever.py`
  - ç»„åˆ BM25 å€™é€‰ + å‘é‡æ£€ç´¢ï¼ˆMMRï¼‰ï¼Œå¯é€‰äº¤å‰ç¼–ç å™¨é‡æ’ï¼ˆ`BAAI/bge-reranker-v2-m3`ï¼‰ã€‚
  - å‘é‡åº“é€šè¿‡ `rag_agent/vectorstore.py` è®¿é—®ï¼Œæ”¯æŒ FAISS æŒä¹…åŒ–æˆ–å†…å­˜å›é€€ã€‚

- Web æ£€ç´¢ï¼š`rag_agent/retriever/web_retriever.py`
  - é€šè¿‡ `rag_agent/utils/websearch.py` è°ƒç”¨ Tavilyï¼›åŸŸåæ˜ å°„æ§åˆ¶å¯é æ€§ï¼ˆå¦‚ `gov.cn=0.95`ï¼‰ã€‚

- ç½®ä¿¡åº¦èåˆå±‚ï¼š`rag_agent/router/fusion_layer.py`
  - åˆ†æ•°ï¼š`score = w_sim*similarity + w_rel*reliability + w_rec*recency`ï¼›æƒé‡æŒ‰æ„å›¾è‡ªé€‚åº”ã€‚
  - æ”¯æŒæ‰¹æ¬¡å½’ä¸€åŒ–ï¼ˆminmax/zscoreï¼‰ä¸ MMR å¤šæ ·åŒ–é€‰æ‹©ï¼ˆ`alpha` å¯è°ƒï¼‰ã€‚

- ç­”æ¡ˆç”Ÿæˆï¼š`rag_agent/llm/answer_generator.py`
  - ä¸¤ç§æ¨¡å¼ï¼šä¸¥æ ¼ JSON è¾“å‡ºï¼ˆå« `answer/citations/confidence`ï¼‰ä¸æµå¼çº¯æ–‡æœ¬è¾“å‡ºã€‚
  - å¼•ç”¨ä¼˜å…ˆæ¥è‡ª `citation/title/source_id`ï¼Œé¿å…é‡å¤ã€‚

- æ€»çº¿ä¸ç¼–æ’ï¼š`rag_agent/pipeline.py`
  - ä¸²è”â€œåˆ†ç±» â†’ è·¯ç”± â†’ æ£€ç´¢ â†’ èåˆ â†’ ç”Ÿæˆâ€ï¼Œå¹¶åœ¨ `meta` ä¸­è®°å½•æ„å›¾ã€å‘½ä¸­æ¡æ•°ç­‰ã€‚

## ä½¿ç”¨è¯´æ˜

- å•æ¬¡é—®ç­”ï¼ˆæµå¼è¾“å‡ºï¼‰ï¼š
  - `python -m rag_agent.cli "ä½ çš„é—®é¢˜"`
- **è°ƒè¯•æ¨¡å¼**ï¼ˆæ˜¾ç¤º pipeline æ¯å±‚è¯¦ç»†æ—¥å¿—ï¼‰ï¼š
  - `python -m rag_agent.cli --debug "ä½ çš„é—®é¢˜"`
  - è°ƒè¯•è¾“å‡ºåŒ…æ‹¬ï¼šæ„å›¾åˆ†ç±»ã€æ£€ç´¢è·¯ç”±ã€æœ¬åœ°/Web æ£€ç´¢ç»“æœã€èåˆå±‚æ’åºã€ç”Ÿæˆç»“æœç­‰
  - ä½¿ç”¨ä¸åŒé¢œè‰²åŒºåˆ†å„é˜¶æ®µï¼šğŸ§  æ„å›¾(é’è‰²)ã€ğŸ”€ è·¯ç”±(é»„è‰²)ã€ğŸ“š æœ¬åœ°(ç»¿è‰²)ã€ğŸŒ Web(è“è‰²)ã€âš—ï¸ èåˆ(å“çº¢)ã€âœ¨ ç”Ÿæˆ(çº¢è‰²)
  - æ¯ä¸ªæ­¥éª¤æ˜¾ç¤ºè€—æ—¶ï¼ˆâ±ï¼‰ï¼Œæœ€åæ±‡æ€»å±•ç¤º Timing Breakdown
- äº¤äº’æ¨¡å¼ï¼ˆREPLï¼‰ï¼š
  - `python -m rag_agent.cli`ï¼Œé€æ¡è¾“å…¥é—®é¢˜ï¼Œè¾“å…¥ `/q` é€€å‡ºã€‚
  - äº¤äº’æ¨¡å¼ä¹Ÿæ”¯æŒè°ƒè¯•ï¼š`python -m rag_agent.cli --debug`
  - å¼€å¯çŸ­æœŸè®°å¿†ï¼ˆLangGraph åŒ…è£¹å¼æ¥å…¥ï¼‰ï¼š
    - `python -m rag_agent.cli --enable-memory`
    - å¯é€‰æŒ‡å®šä¼šè¯IDï¼š`--thread-id your-session-id`ï¼ˆé»˜è®¤ä½¿ç”¨ `--trace-id` æˆ– `repl`ï¼‰
- æ‰¹é‡é—®ç­”åˆ°æ–‡ä»¶ï¼ˆJSONLï¼‰ï¼š
  - å‡†å¤‡ä¸€ä¸ª `questions.txt`ï¼Œæ¯è¡Œä¸€ä¸ªé—®é¢˜ã€‚
  - è¿è¡Œï¼š`python -m rag_agent.cli --input questions.txt --output outputs/answers.jsonl`
  - è¿½åŠ å†™å…¥ï¼šåŠ  `--append`ï¼›å¯é€‰ `--trace-id` ä¾¿äºæ—¥å¿—è¿½è¸ªã€‚
  - è¾“å‡ºä¸º JSONLï¼Œæ¯è¡ŒåŒ…å«ï¼š`question`ã€`answer`ã€`citations`ã€`confidence`ã€`meta`ã€‚

### çŸ­æœŸè®°å¿†è¯´æ˜

- ç±»å‹ï¼šçº¿ç¨‹çº§çŸ­æœŸè®°å¿†ï¼Œä»…ç”¨äºä¿ç•™å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œä¸ä½œä¸ºæ–°çš„è¯æ®æ¥æºã€‚
- è¡Œä¸ºï¼šè®°å¿†åŒ…è£¹å¤–å±‚å¯¹è¯ï¼Œå†…éƒ¨æ£€ç´¢ä¸ç”Ÿæˆä»åªä¾æ®å½“è½® `contexts` è¾“å‡ºä¸å¼•ç”¨ã€‚
- ä¾èµ–ï¼š`langgraph`ï¼ˆæœªå®‰è£…æˆ–åˆå§‹åŒ–å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æ™®é€šæ¨¡å¼ï¼‰ã€‚

## æ•°æ®é¢„å¤„ç†ä¸å‘é‡ç´¢å¼•

- PDF é¢„å¤„ç†ä¸º JSONLï¼š
  - `python -m rag_agent.common.process_pdf --input_dir data --output_dir outputs`
  - ç”Ÿæˆï¼š`outputs/text_chunks.jsonl`ã€`outputs/table_chunks.jsonl`ã€`outputs/all_chunks.jsonl`

- æ„å»º/æ›´æ–°å‘é‡åº“ï¼ˆFAISS æˆ–å†…å­˜ï¼‰ï¼š
  - `python -m rag_agent.utils.embed_and_store --backend faiss --faiss_dir outputs/vector_store --inputs outputs/all_chunks.jsonl --dedup`
  - è¿è¡Œæ—¶ä¹Ÿå¯é€šè¿‡ç¯å¢ƒå˜é‡è§¦å‘é‡å»ºï¼š`REBUILD_VECTOR_STORE=true`

## é…ç½®ï¼ˆ.envï¼‰

- æ¨¡å‹ä¸æ¸©åº¦ï¼š
  - `RESPONSE_MODEL=deepseek:deepseek-chat`
  - `RESPONSE_TEMPERATURE=0.7`
- API Keyï¼ˆä»»é€‰å…¶ä¸€æˆ–ç»„åˆï¼‰ï¼š
  - `DEEPSEEK_API_KEY=...` æˆ– `GOOGLE_API_KEY=...`
  - Doubao/Arkï¼š`ARK_API_KEY=...`ï¼Œ`ARK_BASE_URL=...`
  - Tavilyï¼ˆWeb æ£€ç´¢ï¼‰ï¼š`TAVILY_API_KEY=...`
- æ£€ç´¢ä¸ç´¢å¼•ï¼š
  - `OUTPUTS_DIR=outputs`
  - `ALL_CHUNKS_PATH=outputs/all_chunks.jsonl`
  - `VECTOR_STORE_PATH=outputs/vector_store`
  - `REBUILD_VECTOR_STORE=false`
  - `HF_EMBED_MODEL=Qwen/Qwen3-Embedding-0.6B`
  - `USE_MMR=true`ï¼Œ`MMR_FETCH_MULTIPLIER=3.0`ï¼Œ`MMR_LAMBDA_MULT=0.3`
  - `USE_CROSS_ENCODER=true`ï¼Œ`CROSS_ENCODER_MODEL=BAAI/bge-reranker-v2-m3`
  - `BM25_K1=1.5`ï¼Œ`BM25_B=0.75`
- èåˆå±‚ï¼š
  - `FUSION_USE_NORMALIZATION=true`ï¼Œ`FUSION_NORM_METHOD=minmax`
  - `FUSION_USE_MMR=true`ï¼Œ`FUSION_MMR_ALPHA=0.35`ï¼Œ`FUSION_MMR_FETCH_MULTIPLIER=2.5`
- **å¯è§‚æµ‹æ€§ï¼ˆLangSmithï¼‰**ï¼š
  - `LANGCHAIN_TRACING_V2=true`ï¼šå¯ç”¨ LangSmith è¿½è¸ª
  - `LANGCHAIN_API_KEY=...`ï¼šLangSmith API Key
  - `LANGCHAIN_PROJECT=rag-agent`ï¼šLangSmith é¡¹ç›®åç§°ï¼ˆå¯é€‰ï¼‰
  - å¯ç”¨åï¼Œæ‰€æœ‰ LLM è°ƒç”¨ä¼šè‡ªåŠ¨ä¸ŠæŠ¥åˆ° LangSmith æ§åˆ¶å°

## è·¯ç”±ä¸ Top-K

- `TOP_K`: æœ¬åœ°æ£€ç´¢ `5`ï¼ŒWeb æ£€ç´¢ `5`ï¼Œèåˆå±‚ `6`ï¼ˆå¯åœ¨é…ç½®ä¸­è°ƒæ•´ï¼‰ã€‚
- æ¥æºå¯é æ€§ï¼š`local=0.9`ï¼Œ`web=0.6`ï¼ˆå¯¹éƒ¨åˆ†åŸŸåå¯æå‡ï¼Œå¦‚ `gov.cn=0.95`ï¼‰ã€‚

## è¾“å‡º

- æµå¼æ¨¡å¼ï¼šç»ˆç«¯å…ˆæ‰“å°æœ€ç»ˆç­”æ¡ˆæ–‡æœ¬ï¼Œå†æ‰“å° `Citations` åˆ—è¡¨ã€‚
- æ‰¹é‡æ¨¡å¼ï¼ˆJSONLï¼‰ï¼šæ¯è¡ŒåŒ…å«ï¼š
  - `question`ï¼Œ`answer`ï¼ˆæ–‡æœ¬ï¼‰ï¼Œ`citations`ï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼‰ï¼Œ`confidence`ï¼ˆ0-1ï¼‰ï¼Œ`meta`ï¼ˆè¯Šæ–­ä¿¡æ¯ï¼‰ã€‚
